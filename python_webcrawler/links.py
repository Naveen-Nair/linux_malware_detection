from selenium import webdriver
from selenium.webdriver.common.by import By
import csv
import sys
import tqdm

###########################################################################################################################################################################

if(len(sys.argv)!=3) :
    print('Enter start and end params')
    exit()

###########################################################################################################################################################################

start = int(sys.argv[1])
end = int(sys.argv[2])
filename = "output/links.csv"

###########################################################################################################################################################################

driver = webdriver.Firefox()
driver.get("https://www.vx-underground.org/#E:/root/Samples/Families")

elems = driver.find_elements(By.CLASS_NAME, 'folder_link')
families = []
for i in tqdm.tqdm(range(4,len(elems)), desc="Getting Families..."):
    families.append(elems[i].text)

###########################################################################################################################################################################

end = min(end, len(families))
start = max(start, 0)
if end<=start :
    print('Range is wrong')
    driver.close()
    exit()

###########################################################################################################################################################################

links=[]

for i in tqdm.tqdm(range(start, end), desc="parsing links..."):
    family = families[i]
    try:
        #go back to google so that link is reset
        driver.get("https://www.google.com/")
        driver.get("https://www.vx-underground.org/#E:/root/Samples/Families/"+family)
        thing = driver.find_element(By.CLASS_NAME, 'tablesorter')
        #find the list of viruses
        viruses = thing.find_elements(By.CSS_SELECTOR, 'tbody>tr')

        #some viruses have Samples inside, so we have to go into those folders
        if(len(viruses)>=2 and viruses[1].find_element(By.CSS_SELECTOR, 'a').text == 'Samples'):
            driver.get("https://www.google.com/")
            driver.get("https://www.vx-underground.org/#E:/root/Samples/Families/"+family+"/Samples")
            thing = driver.find_element(By.CLASS_NAME, 'tablesorter')
            viruses = thing.find_elements(By.CSS_SELECTOR, 'tbody>tr')

        for virus in viruses:
            anchor = virus.find_element(By.CSS_SELECTOR, 'a')
            size = virus.find_element(By.CSS_SELECTOR, '.size').text.split(' ')
            if(size[1]=='GB' or (size[1]=='MB' and float(size[0]) > 10)):
                continue
            flag = True
            links.append([family, anchor.get_attribute('href')])
            break
        
    except:
        print('error in ',family)

###########################################################################################################################################################################

driver.close()

###########################################################################################################################################################################

with open(filename, mode='w') as links_csv:
    links_writer = csv.writer(links_csv, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)
    links_writer.writerows(links)

###########################################################################################################################################################################
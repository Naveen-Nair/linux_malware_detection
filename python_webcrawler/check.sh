#!/usr/bin/bash

mkdir -p output/download 2> /dev/null
arr=($(awk -F ',' '{print $2}' output/links.csv))
for key in "${arr[@]}"
do
    # File endings are inconsistent => update based on ending
    key2="${key%.*}.7z"
    wget --directory output/download "$key2"
    key3="${key2##*/}"

    # Extract the name of the file without extension
    first_file="$(basename "$key3" .7z)"

    # Unzipping the .7z file
    7za e "output/download/$key3" -p"infected" -o"output/download/"


    if [ -e "output/download/$file_name" ]; then
        chmod +x "output/download/$first_file"

        # Try to execute the first file
        "./output/download/$first_file" &> /dev/null
        exit_status="$?"

        if [ "$exit_status" -eq 0 ]; then
            # Append to the executable families CSV
            grep "$key3" output/links.csv | awk -F "," '{print $1}' >> output/executablefamilies.csv
        else
            # Append to the non-executable families CSV
            grep "$key3" output/links.csv | awk -F "," '{print $1}' >> output/nonExecfamilies.csv
        fi

        # Append to the general families CSV
        grep "$key3" output/links.csv | awk -F "," '{print $1}' >> output/families.csv

        # Print the name of the first file and extracted file name
    else
        grep "$key3" output/links.csv | awk -F "," '{print $1}' >> output/noFileFound.csv
    fi

done
